<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IKIZULIVE</title>

<style>
body{
  margin:0;
  font-family:Arial, Helvetica, sans-serif;
  background:#e9ecef;
}

.wrapper{
  display:flex;
  height:100vh;
}

/* LEFT */
/* LEFT PANEL */
.left{
  width:260px;
  background:#f1f1f1;
  padding:20px;
  border-right:1px solid #ccc;
}

.left h2{ margin-top:0; }

.left textarea{
  width:100%;
  margin-bottom:10px;
}

.left button{
  background:black;
  color:white;
  border:none;
  padding:8px 12px;
  cursor:pointer;
}

/* CENTER */
.center{
  flex:1;
  padding:30px;
  overflow-y:auto;
}

.post-card{
  background:white;
  padding:20px;
  border-radius:14px;
  margin-bottom:30px;
}

.post-card blockquote{
  margin-bottom:20px;
}

.post-actions{
  margin-top:15px;
}

.btn-dark{
  background:black;
  color:white;
  border:none;
  padding:6px 12px;
  margin-right:5px;
  cursor:pointer;
}

.btn-danger{
  background:#dc3545;
  color:white;
  border:none;
  padding:6px 12px;
  cursor:pointer;
}

/* RIGHT */
.right{
  width:260px;
  background:#f8f9fa;
  padding:20px;
  border-left:1px solid #ccc;
}

.timeline-btn{
  display:block;
  width:100%;
  margin-bottom:10px;
  background:#333;
  color:white;
  border:none;
  padding:10px;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="wrapper">

<!-- LEFT -->
<div class="left">
<h2>IKIZULIVE</h2>

<h4>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏û‡∏™‡∏ï‡πå</h4>
<p>1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡∏•‡∏¥‡∏á‡∏Å‡πå</p>
<textarea id="linkInput" rows="8"></textarea>

<p>‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•</p>
<textarea id="translateInput" rows="5"></textarea>

<button onclick="addPosts()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
</div>

<!-- CENTER -->
<div class="center">
<div id="posts"></div>
</div>

<!-- RIGHT -->
<div class="right">
<h3>Timeline</h3>
<button class="timeline-btn" onclick="showAll()">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
<div id="timelineButtons"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  deleteDoc, 
  doc, 
  onSnapshot, 
  query, 
  orderBy, 
  Timestamp 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* üî• ‡πÉ‡∏™‡πà config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
  apiKey: "AIzaSyDlybmqJBVyC2B3Kh09KfbsO0XvH5Md2Vo",
  authDomain: "ikizuliveth.firebaseapp.com",
  projectId: "ikizuliveth",
  storageBucket: "ikizuliveth.firebasestorage.app",
  messagingSenderId: "435466293836",
  appId: "1:435466293836:web:15c46e9be1b484c91b9ae9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const postsRef = collection(db,"posts");

const postsContainer = document.getElementById("posts");
const timelineContainer = document.getElementById("timelineButtons");

let allPosts = [];
let monthMap = {};

/* ===== ‡πÅ‡∏õ‡∏•‡∏á Tweet ID ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ===== */
/* ===== ‡πÅ‡∏õ‡∏•‡∏á Tweet ID ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ===== */
function getDateFromTweetId(postId){
  try{
    const twitterEpoch = 1288834974657n;
    const timestamp = (BigInt(postId) >> 22n) + twitterEpoch;
    return new Date(Number(timestamp));
  }catch{
    return new Date();
  }
  const twitterEpoch = 1288834974657n;
  const timestamp = (BigInt(postId) >> 22n) + twitterEpoch;
  return new Date(Number(timestamp));
}

/* ===== ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå ===== */
function render(posts){
  postsContainer.innerHTML="";
  posts.forEach(p=>createPost(p));
  if(window.twttr) window.twttr.widgets.load();
}

/* ===== ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î ===== */
function createPost(post){
  const div=document.createElement("div");
  div.className="post-card";

  const ids = post.postIds || [post.postId];
  div.innerHTML=`
    <blockquote class="twitter-tweet">
      <a href="https://twitter.com/i/status/${post.postId}"></a>
    </blockquote>

  let tweetsHTML = "";

  ids.forEach(id=>{
    tweetsHTML += `
      <blockquote class="twitter-tweet">
        <a href="https://twitter.com/i/status/${id}"></a>
      </blockquote>
    `;
  });

  div.innerHTML = `
    ${tweetsHTML}
    <div class="post-actions">
      <button class="btn-dark" onclick="toggleTranslate('${post.id}')">‡∏î‡∏π‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•</button>
      <button class="btn-danger" onclick="deletePost('${post.id}')">‡∏•‡∏ö</button>
    </div>

    <p id="trans-${post.id}" style="display:none;margin-top:10px;">
      ${post.content || ""}
      ${post.content}
    </p>
  `;

  postsContainer.appendChild(div);
}

/* ===== toggle ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏• ===== */
/* ===== ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏• ===== */
window.toggleTranslate=(id)=>{
  const el=document.getElementById("trans-"+id);
  el.style.display = el.style.display==="none"?"block":"none";
}

/* ===== ‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå ===== */
window.deletePost=async(id)=>{
  await deleteDoc(doc(db,"posts",id));
}

/* ===== ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏û‡∏™‡∏ï‡πå ===== */
/* ===== ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏û‡∏™‡∏ï‡πå (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£) ===== */
window.addPosts=async()=>{
  const links=document.getElementById("linkInput").value.split("\n");
  const translate=document.getElementById("translateInput").value;

  let postIds=[];
  let autoDate=null;

  for(let link of links){
    if(!link.trim()) continue;

    const match = link.match(/status\/(\d+)/);
    if(!match) continue;
    try{
      const match = link.match(/status\/(\d+)/);
      if(!match) continue;

    const postId = match[1];
    postIds.push(postId);
      const postId = match[1];
      const autoDate = getDateFromTweetId(postId);

    if(!autoDate){
      autoDate = getDateFromTweetId(postId);
    }
  }
      await addDoc(postsRef,{
        postId:postId,
        content:translate,
        createdAt:Timestamp.fromDate(autoDate)
      });

  if(postIds.length===0){
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    return;
    }catch(err){
      console.error("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", link, err);
    }
  }

  await addDoc(postsRef,{
    postIds:postIds,
    content:translate,
    createdAt:autoDate ? Timestamp.fromDate(autoDate) : Timestamp.now()
  });

  document.getElementById("linkInput").value="";
  document.getElementById("translateInput").value="";
}

/* ===== Timeline ===== */
window.showAll=()=>render(allPosts);

const q=query(postsRef,orderBy("createdAt","asc"));

onSnapshot(q,(snapshot)=>{
  allPosts=[];
  monthMap={};
  timelineContainer.innerHTML="";

  snapshot.forEach(docSnap=>{
    const data=docSnap.data();

    if(!data.createdAt){
      data.createdAt = Timestamp.now();
    }
    if(!data.createdAt) return;

    const date=data.createdAt.toDate();
    const month=date.getMonth()+1;
    const year=date.getFullYear();
    const key=`${month}-${year}`;

    const post={id:docSnap.id,...data};
    allPosts.push(post);

    if(!monthMap[key]) monthMap[key]=[];
    monthMap[key].push(post);
  });

  Object.keys(monthMap)
    .sort((a,b)=>{
      const [m1,y1]=a.split("-");
      const [m2,y2]=b.split("-");
      return new Date(y1,m1-1)-new Date(y2,m2-1);
    })
    .forEach(key=>{
      const [m,y]=key.split("-");
      const btn=document.createElement("button");
      btn.className="timeline-btn";
      btn.innerText=`‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà ${m} ‡∏õ‡∏µ ${y}`;
      btn.onclick=()=>render(monthMap[key]);
      timelineContainer.appendChild(btn);
    });

  render(allPosts);
});
</script>

<script async src="https://platform.twitter.com/widgets.js"></script>

</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>X Translation Archive</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f5f8fa;
}

.container {
  display: grid;
  grid-template-columns: 250px 1fr 300px;
  height: 100vh;
}

.sidebar {
  background: white;
  padding: 20px;
  border-right: 1px solid #ddd;
}

.feed {
  padding: 20px;
  overflow-y: auto;
}

.timeline {
  background: white;
  padding: 20px;
  border-left: 1px solid #ddd;
  overflow-y: auto;
}

.post-group {
  background: white;
  padding: 15px;
  margin-bottom: 25px;
  border-radius: 12px;
}

.translation {
  display: none;
  background: #f0f0f0;
  padding: 10px;
  margin-top: 10px;
  border-radius: 8px;
  white-space: pre-wrap;
}

button {
  margin-top: 8px;
  padding: 6px 10px;
  border: none;
  background: black;
  color: white;
  cursor: pointer;
  border-radius: 5px;
  margin-right: 5px;
}

.delete-btn {
  background: #d11a2a;
}

.timeline button {
  display: block;
  width: 100%;
  margin-bottom: 8px;
  background: #444;
}

textarea {
  width: 100%;
  padding: 6px;
  margin-top: 5px;
  box-sizing: border-box;
}
</style>
</head>

<body>

<div class="container">

<div class="sidebar">
  <h3>เพิ่มหลายโพสต์</h3>

  <textarea id="postUrls" rows="5" placeholder="1 บรรทัด = 1 ลิงก์"></textarea>

  <textarea id="postTranslation" rows="5" placeholder="คำแปล"></textarea>

  <button onclick="addPostGroup()">เพิ่มโพสต์</button>
</div>

<div class="feed"></div>

<div class="timeline">
  <h3>Timeline</h3>
  <button onclick="showAll()">แสดงทั้งหมด</button>
  <div id="timelineButtons"></div>
</div>

</div>

<script async src="https://platform.twitter.com/widgets.js"></script>

<script>

async function fetchTweetDate(url){
  const response = await fetch(
    `https://publish.twitter.com/oembed?url=${encodeURIComponent(url)}`
  );
  const data = await response.json();

  const temp = document.createElement("div");
  temp.innerHTML = data.html;

  const timeElement = temp.querySelector("time");
  const datetime = timeElement?.getAttribute("datetime");

  if(!datetime) return null;

  return new Date(datetime);
}

async function addPostGroup(){
  const urlsText = document.getElementById("postUrls").value.trim();
  const translation = document.getElementById("postTranslation").value.trim();

  if(!urlsText) return alert("กรุณาใส่ลิงก์");

  const urls = urlsText.split("\n")
    .map(u=>u.trim())
    .filter(u=>u!=="")
    .map(u=>u.replace("x.com","twitter.com").split("?")[0]);

  const firstUrl = urls[0];

  const tweetDate = await fetchTweetDate(firstUrl);

  if(!tweetDate){
    alert("ไม่สามารถดึงวันที่โพสต์ได้");
    return;
  }

  const month = tweetDate.getMonth()+1;
  const year = tweetDate.getFullYear();

  const id = Date.now();

  createPostGroup(id, urls, translation, month, year, tweetDate, true);

  document.getElementById("postUrls").value="";
  document.getElementById("postTranslation").value="";
}

function createPostGroup(id, urls, translation, month, year, fullDate, save=false){
  const feed = document.querySelector(".feed");

  const div = document.createElement("div");
  div.className="post-group";
  div.dataset.month=month;
  div.dataset.year=year;
  div.dataset.date=fullDate;

  let tweetsHTML="";

  urls.forEach(url=>{
    tweetsHTML+=`
      <blockquote class="twitter-tweet">
        <a href="${url}"></a>
      </blockquote>
    `;
  });

  div.innerHTML=`
    <small>เดือนที่ ${month} ปี ${year}</small>
    ${tweetsHTML}
    <button onclick="toggle(this)">ดูคำแปล</button>
    <button class="delete-btn" onclick="deleteGroup(${id})">ลบ</button>
    <div class="translation">${translation}</div>
  `;

  feed.appendChild(div);

  if(window.twttr){
    window.twttr.widgets.load(div);
  }

  if(save){
    saveGroup(id, urls, translation, month, year, fullDate);
    updateTimeline();
    sortPosts();
  }
}

function sortPosts(){
  const feed = document.querySelector(".feed");
  const posts = Array.from(feed.children);

  posts.sort((a,b)=>{
    return new Date(a.dataset.date) - new Date(b.dataset.date);
  });

  posts.forEach(p=>feed.appendChild(p));
}

function toggle(btn){
  const t=btn.parentElement.querySelector(".translation");
  t.style.display=t.style.display==="block"?"none":"block";
}

function deleteGroup(id){
  location.reload();
}

function saveGroup(id, urls, translation, month, year, date){
  let groups=JSON.parse(localStorage.getItem("groups"))||[];
  groups.push({id,urls,translation,month,year,date});
  localStorage.setItem("groups",JSON.stringify(groups));
}

function loadGroups(){
  let groups=JSON.parse(localStorage.getItem("groups"))||[];

  groups.forEach(g=>{
    createPostGroup(g.id,g.urls,g.translation,g.month,g.year,g.date,false);
  });

  updateTimeline();
  sortPosts();
}

function updateTimeline(){
  const container=document.getElementById("timelineButtons");
  container.innerHTML="";

  let groups=JSON.parse(localStorage.getItem("groups"))||[];

  const unique=[...new Set(groups.map(g=>`${g.month}-${g.year}`))];

  unique.sort((a,b)=>{
    const [m1,y1]=a.split("-").map(Number);
    const [m2,y2]=b.split("-").map(Number);
    return y1!==y2?y1-y2:m1-m2;
  });

  unique.forEach(key=>{
    const [month,year]=key.split("-");
    const btn=document.createElement("button");
    btn.innerText=`เดือนที่ ${month} ปี ${year}`;
    btn.onclick=()=>filterByMonth(month,year);
    container.appendChild(btn);
  });
}

function filterByMonth(month,year){
  document.querySelectorAll(".post-group").forEach(p=>{
    p.style.display=
      p.dataset.month===month && p.dataset.year===year
      ? "block":"none";
  });
}

function showAll(){
  document.querySelectorAll(".post-group").forEach(p=>{
    p.style.display="block";
  });
}

document.addEventListener("DOMContentLoaded",loadGroups);

</script>

</body>
</html>

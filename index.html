<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IKIZULIVETH</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#ffffff;
}

header{
  padding:20px;
  font-size:24px;
  font-weight:bold;
  border-bottom:1px solid #ddd;
}

.container{
  display:flex;
  max-width:1200px;
  margin:auto;
}

.main{
  width:70%;
  padding:20px;
}

.timeline{
  width:30%;
  border-left:1px solid #ddd;
  padding:20px;
  background:#fafafa;
}

.post{
  margin-bottom:40px;
}

.post p{
  margin-top:10px;
}

button{
  padding:6px 10px;
  margin-top:8px;
  cursor:pointer;
}

textarea{
  width:100%;
  height:100px;
  margin-top:10px;
}

.timeline button{
  display:block;
  width:100%;
  margin-bottom:8px;
}
</style>
</head>

<body>

<header>IKIZULIVETH</header>

<div class="container">

<div class="main">

<h3>เพิ่มหลายโพสต์พร้อมกัน</h3>
<p>รูปแบบ: postId | คำแปล | YYYY-MM-DD</p>
<textarea id="bulkInput"></textarea>
<button onclick="addPosts()">เพิ่มโพสต์</button>

<hr>

<div id="posts"></div>

</div>

<div class="timeline">
<h3>Timeline</h3>
<div id="timelineButtons"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDlybmqJBVyC2B3Kh09KfbsO0XvH5Md2Vo",
  authDomain: "ikizuliveth.firebaseapp.com",
  projectId: "ikizuliveth",
  storageBucket: "ikizuliveth.firebasestorage.app",
  messagingSenderId: "435466293836",
  appId: "1:435466293836:web:15c46e9be1b484c91b9ae9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const postsRef = collection(db, "posts");

const postsContainer = document.getElementById("posts");
const timelineContainer = document.getElementById("timelineButtons");

function render(snapshot){

  postsContainer.innerHTML="";
  timelineContainer.innerHTML="";

  let monthMap={};

  snapshot.forEach(docSnap=>{
    const data=docSnap.data();
    const date=data.createdAt.toDate();
    const key=`${date.getMonth()+1}-${date.getFullYear()}`;

    if(!monthMap[key]) monthMap[key]=[];
    monthMap[key].push({id:docSnap.id,...data});
  });

  Object.keys(monthMap).forEach(key=>{
    const [month,year]=key.split("-");
    const btn=document.createElement("button");
    btn.innerText=`เดือนที่ ${month} ปี ${year}`;
    btn.onclick=()=>{
      postsContainer.innerHTML="";
      monthMap[key].forEach(post=>createPost(post));
      if(window.twttr) window.twttr.widgets.load();
    };
    timelineContainer.appendChild(btn);
  });

  snapshot.forEach(docSnap=>{
    createPost({id:docSnap.id,...docSnap.data()});
  });

  if(window.twttr) window.twttr.widgets.load();
}

function createPost(post){
  const div=document.createElement("div");
  div.className="post";

  div.innerHTML=`
    <blockquote class="twitter-tweet">
      <a href="https://twitter.com/i/status/${post.postId}"></a>
    </blockquote>
    <p>${post.content}</p>
    <button onclick="deletePost('${post.id}')">ลบโพสต์</button>
    <hr>
  `;

  postsContainer.appendChild(div);
}

window.deletePost=async(id)=>{
  await deleteDoc(doc(db,"posts",id));
};

window.addPosts=async()=>{
  const raw=document.getElementById("bulkInput").value;
  const lines=raw.split("\n");

  for(let line of lines){
    if(!line.trim()) continue;

    const [postId,content,dateStr]=line.split("|");

    await addDoc(postsRef,{
      postId:postId.trim(),
      content:content.trim(),
      createdAt:Timestamp.fromDate(new Date(dateStr.trim()))
    });
  }

  document.getElementById("bulkInput").value="";
};

const q=query(postsRef,orderBy("createdAt","asc"));
onSnapshot(q,(snapshot)=>{
  render(snapshot);
});
</script>

<script async src="https://platform.twitter.com/widgets.js"></script>

</body>
</html>

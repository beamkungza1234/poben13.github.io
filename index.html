<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IKIZULIVE</title>
<link rel="stylesheet" href="style.css">
<script type="text/javascript" src="darkmode.js" defer></script>

</head>

<body>
<!-- MOBILE HEADER -->
<div class="mobile-header">
  <div class="logo-mobile">IKIZULIVE</div>
  <button class="hamburger" onclick="toggleTimeline()">☰</button>
</div>

<div class="wrapper">

<!-- LEFT -->
<div class="left">
<h2>IKIZULIVE</h2>

<h4>รหัสแอดมิน</h4>
<input type="password" id="adminCode" placeholder="กรอกรหัสแอดมิน">
<button onclick="checkAdmin()">เข้าสู่ระบบ</button>
<div class="admin-status" id="adminStatus">ยังไม่ได้เข้าสู่ระบบ</div>

<hr>

<h4>เพิ่มหลายโพสต์</h4>
<p>1 บรรทัด = 1 ลิงก์</p>
<textarea id="linkInput" rows="6" type="checkbox" placeholder="ex. https://x.com/user/status/123456"></textarea>

<p>คำแปล</p>
<textarea id="translateInput" rows="4" type="checkbox"></textarea>

<button onclick="addPosts()">เพิ่มโพสต์</button>
</div>

<!-- CENTER -->
<div class="center">
<div id="posts"></div>
</div>

<!-- RIGHT -->
<div class="right">
  <button class="hamburger" onclick="toggleTimeline()">☰</button>
    <header>
      <button id="theme-switch" type="button">
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M484-80q-84 0-157.5-32t-128-86.5Q144-253 112-326.5T80-484q0-146 93-257.5T410-880q-18 99 11 193.5T521-521q71 71 165.5 100T880-410q-26 144-138 237T484-80Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M338.5-338.5Q280-397 280-480t58.5-141.5Q397-680 480-680t141.5 58.5Q680-563 680-480t-58.5 141.5Q563-280 480-280t-141.5-58.5ZM200-440H40v-80h160v80Zm720 0H760v-80h160v80ZM440-760v-160h80v160h-80Zm0 720v-160h80v160h-80ZM256-650l-101-97 57-59 96 100-52 56Zm492 496-97-101 53-55 101 97-57 59Zm-98-550 97-101 59 57-100 96-56-52ZM154-212l101-97 55 53-97 101-59-57Z"/></svg>
      </button>
    </header>
  <span class="slider"></span>
</label>

<h3>Timeline</h3>
<button class="timeline-btn" onclick="showAll(); closeTimeline()">แสดงทั้งหมด</button>
<div id="timelineButtons"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const ADMIN_PASSWORD = "6767";
let isAdmin = false;

window.checkAdmin = () => {
  const input = document.getElementById("adminCode").value;
  const status = document.getElementById("adminStatus");

  if(input === ADMIN_PASSWORD){
    isAdmin = true;
    status.innerText = "เข้าสู่ระบบสำเร็จ ✅";
    status.style.color = "green";
  }else{
    isAdmin = false;
    status.innerText = "รหัสไม่ถูกต้อง ❌";
    status.style.color = "red";
  }
};

window.toggleTimeline = () => {
  const panel = document.querySelector(".right");
  panel.classList.toggle("active");
}

window.closeTimeline = () => {
  const panel = document.querySelector(".right");
  panel.classList.remove("active");
}

/* Firebase */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "ikizuliveth.firebaseapp.com",
  projectId: "ikizuliveth",
  storageBucket: "ikizuliveth.firebasestorage.app",
  messagingSenderId: "435466293836",
  appId: "1:435466293836:web:15c46e9be1b484c91b9ae9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const postsRef = collection(db,"posts");

const postsContainer = document.getElementById("posts");
const timelineContainer = document.getElementById("timelineButtons");

let allPosts = [];
let monthMap = {};

function getDateFromTweetId(postId){
  const twitterEpoch = 1288834974657n;
  const timestamp = (BigInt(postId) >> 22n) + twitterEpoch;
  return new Date(Number(timestamp));
}

function render(posts){
  postsContainer.innerHTML="";
  posts.forEach(p=>createPost(p));
  if(window.twttr) window.twttr.widgets.load();
}

function createPost(post){
  const div=document.createElement("div");
  div.className="post-card";
  div.id = `post-card-${post.id}`

  let tweetsHTML="";
  post.postIds.forEach(id=>{
    tweetsHTML+=`
      <blockquote class="twitter-tweet">
        <a href="https://twitter.com/i/status/${id}"></a>
      </blockquote>
    `;
  });

  div.innerHTML=`
    ${tweetsHTML}
    <div class="post-actions">
      <button class="btn-dark" onclick="toggleTranslate('${post.id}')">ดูคำแปล</button>
      <button class="btn-dark" onclick="editPost('${post.id}')">แก้ไขคำแปล</button>
      <button class="btn-danger" onclick="deletePost('${post.id}')">ลบ</button>
    </div>
    <p id="trans-${post.id}" class="translation" style="display:none;">
      ${post.content}
    </p>
  `;

  const pTag = div.querySelector(`#trans-${post.id}`)
  if(pTag) pTag.innerText = post.content;

  postsContainer.appendChild(div);

  if(window.twttr && document.querySelectorAll(`.post-card`).length > 1) {
    const newTweets = div.querySelectorAll(`twitter-tweet`);
    newTweets.forEach(t => window.twttr.widgets.load(t));
  }

}

window.toggleTranslate=id=>{
  const el=document.getElementById("trans-"+id);
  if(el) el.style.display = el.style.display==="none"?"block":"none";
}

window.deletePost=async id=>{
  if(!isAdmin){
    alert("คุณไม่มีสิทธิ์ลบโพสต์ ❌");
    return;
  }
  if(!confirm("ยืนยันการลบโพสต์?")) return;
  
  await deleteDoc(doc(db,"posts",id));
}

window.editPost=async id=>{
  if(!isAdmin){
    alert("คุณไม่มีสิทธิ์แก้ไข ❌");
    return;
  }

  const post = allPosts.find(p=>p.id===id);
  if(!post) return;

  const newContent=prompt("แก้ไขคำแปล:",post.content);
  if(newContent===null) return;

  await updateDoc(doc(db,"posts",id),{
    content:newContent
  });
}

window.addPosts=async()=>{
  const links=document.getElementById("linkInput").value.split("\n");
  const translate=document.getElementById("translateInput").value;

  const postIds=[];
  for(let link of links){
    const match=link.match(/status\/(\d+)/);
    if(match) postIds.push(match[1]);
  }

  if(postIds.length===0) return;

  const autoDate=getDateFromTweetId(postIds[0]);

  await addDoc(postsRef,{
    postIds,
    content:translate,
    createdAt:Timestamp.fromDate(autoDate)
  });

  document.getElementById("linkInput").value="";
  document.getElementById("translateInput").value="";
}

window.showAll=()=>{
    render(allPosts);
    closeTimeline();
};

const q=query(postsRef,orderBy("createdAt","asc"));

onSnapshot(q, snapshot => {
  
  allPosts = [];
  monthMap = {};
  
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const post = { id: docSnap.id, ...data };
    allPosts.push(post); 

    const date = data.createdAt.toDate();
    const key = `${date.getMonth()+1}-${date.getFullYear()}`;
    if (!monthMap[key]) monthMap[key] = [];
    monthMap[key].push(post);
  });
  
  timelineContainer.innerHTML = "";
  Object.keys(monthMap).forEach(key => {
    const [m, y] = key.split("-");
    const btn = document.createElement("button");
    btn.className = "timeline-btn";
    btn.innerText = `เดือนที่ ${m} ปี ${y}`;
    btn.onclick = () => {
      render(monthMap[key]);
      closeTimeline();
    };
    timelineContainer.appendChild(btn);
  });

  snapshot.docChanges().forEach(change => {
    const postData = change.doc.data();
    const postId = change.doc.id;
    const post = { id: postId, ...postData };

    if (change.type === "added") {
      if(!document.getElementById(`post-card-${postId}`)) {
          createPost(post);
      }
    }
    
    if (change.type === "modified") {
      const pTag = document.getElementById(`trans-${postId}`);
      if (pTag) pTag.innerText = post.content;
    }
    
    if (change.type === "removed") {
      const divToRemove = document.getElementById(`post-card-${postId}`);
      if (divToRemove) divToRemove.remove();
    }
  });

  if(snapshot.docChanges().length === snapshot.size && window.twttr){
      window.twttr.widgets.load();
  }
});
</script>

<script async src="https://platform.twitter.com/widgets.js"></script>

</body>
</html>

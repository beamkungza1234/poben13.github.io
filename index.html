<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const ADMIN_PASSWORD = "6767";
let isAdmin = false;

window.checkAdmin = () => {
  const input = document.getElementById("adminCode").value;
  const status = document.getElementById("adminStatus");

  if(input === ADMIN_PASSWORD){
    isAdmin = true;
    status.innerText = "เข้าสู่ระบบสำเร็จ ✅";
    status.style.color = "green";
  }else{
    isAdmin = false;
    status.innerText = "รหัสไม่ถูกต้อง ❌";
    status.style.color = "red";
  }
};

/* Firebase */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "ikizuliveth.firebaseapp.com",
  projectId: "ikizuliveth",
  storageBucket: "ikizuliveth.firebasestorage.app",
  messagingSenderId: "435466293836",
  appId: "1:435466293836:web:15c46e9be1b484c91b9ae9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const postsRef = collection(db,"posts");

const postsContainer = document.getElementById("posts");
const timelineContainer = document.getElementById("timelineButtons");

let allPosts = [];
let monthMap = {};

/* ----------- LAZY LOAD SETUP ----------- */

const observer = new IntersectionObserver((entries)=>{
  entries.forEach(entry=>{
    if(entry.isIntersecting){
      const block = entry.target;
      const tweetId = block.dataset.tweet;
      block.innerHTML = `
        <blockquote class="twitter-tweet">
          <a href="https://twitter.com/i/status/${tweetId}"></a>
        </blockquote>
      `;
      if(window.twttr) window.twttr.widgets.load(block);
      observer.unobserve(block);
    }
  });
},{
  rootMargin:"200px"
});

/* ----------- FUNCTIONS ----------- */

function getDateFromTweetId(postId){
  const twitterEpoch = 1288834974657n;
  const timestamp = (BigInt(postId) >> 22n) + twitterEpoch;
  return new Date(Number(timestamp));
}

function render(posts){
  postsContainer.innerHTML="";
  posts.forEach(p=>createPost(p));
}

function createPost(post){
  const div=document.createElement("div");
  div.className="post-card";

  let tweetsHTML="";
  post.postIds.forEach(id=>{
    tweetsHTML+=`
      <div class="tweet-lazy" data-tweet="${id}" style="min-height:200px; margin-bottom:10px;"></div>
    `;
  });

  div.innerHTML=`
    ${tweetsHTML}
    <div class="post-actions">
      <button class="btn-dark" onclick="toggleTranslate('${post.id}')">ดูคำแปล</button>
      <button class="btn-dark" onclick="editPost('${post.id}')">แก้ไขคำแปล</button>
      <button class="btn-danger" onclick="deletePost('${post.id}')">ลบ</button>
    </div>
    <p id="trans-${post.id}" class="translation" style="display:none;">
      ${post.content}
    </p>
  `;

  postsContainer.appendChild(div);

  /* สั่ง observe ทุก tweet */
  div.querySelectorAll(".tweet-lazy").forEach(el=>{
    observer.observe(el);
  });
}

/* ----------- ADMIN ----------- */

window.toggleTranslate=id=>{
  const el=document.getElementById("trans-"+id);
  el.style.display = el.style.display==="none"?"block":"none";
}

window.deletePost=async id=>{
  if(!isAdmin){
    alert("คุณไม่มีสิทธิ์ลบโพสต์ ❌");
    return;
  }
  await deleteDoc(doc(db,"posts",id));
}

window.editPost=async id=>{
  if(!isAdmin){
    alert("คุณไม่มีสิทธิ์แก้ไข ❌");
    return;
  }

  const post = allPosts.find(p=>p.id===id);
  const newContent=prompt("แก้ไขคำแปล:",post.content);
  if(newContent===null) return;

  await updateDoc(doc(db,"posts",id),{
    content:newContent
  });
}

window.addPosts=async()=>{
  const links=document.getElementById("linkInput").value.split("\n");
  const translate=document.getElementById("translateInput").value;

  const postIds=[];
  for(let link of links){
    const match=link.match(/status\/(\d+)/);
    if(match) postIds.push(match[1]);
  }

  if(postIds.length===0) return;

  const autoDate=getDateFromTweetId(postIds[0]);

  await addDoc(postsRef,{
    postIds,
    content:translate,
    createdAt:Timestamp.fromDate(autoDate)
  });

  document.getElementById("linkInput").value="";
  document.getElementById("translateInput").value="";
}

window.showAll=()=>render(allPosts);

/* ----------- FIRESTORE ----------- */

const q=query(postsRef,orderBy("createdAt","asc"));

onSnapshot(q,snapshot=>{
  allPosts=[];
  monthMap={};
  timelineContainer.innerHTML="";

  snapshot.forEach(docSnap=>{
    const data=docSnap.data();
    const post={id:docSnap.id,...data};
    allPosts.push(post);

    const date=data.createdAt.toDate();
    const key=`${date.getMonth()+1}-${date.getFullYear()}`;

    if(!monthMap[key]) monthMap[key]=[];
    monthMap[key].push(post);
  });

  Object.keys(monthMap).forEach(key=>{
    const [m,y]=key.split("-");
    const btn=document.createElement("button");
    btn.className="timeline-btn";
    btn.innerText=`เดือนที่ ${m} ปี ${y}`;
    btn.onclick=()=>render(monthMap[key]);
    timelineContainer.appendChild(btn);
  });

  render(allPosts);
});
</script>
